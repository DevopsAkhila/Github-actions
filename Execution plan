

---

# ğŸ§ª Exercise 2: Conditional Deployment with Secrets and Approvals

## ğŸ¯ Objectives (What You Will Learn)

* Multi-environment deployment (**dev / staging / prod**)
* Branch-based conditional deployments
* Secure handling of **GitHub Secrets**
* Manual **approval gates** for production
* Dynamic job execution using `if` conditions
* Understanding **environment protections**

---

## ğŸ—‚ï¸ Repository Structure (Create These Files)

```
conditional-deploy-demo/
â”œâ”€â”€ .github/
â”‚   â””â”€â”€ workflows/
â”‚       â””â”€â”€ conditional-deploy.yml
â”œâ”€â”€ scripts/
â”‚   â””â”€â”€ deploy.sh
â”œâ”€â”€ README.md
```

---

## 1ï¸âƒ£ Dummy Deploy Script (Safe for Demo)

### ğŸ“„ `scripts/deploy.sh`

```bash
#!/bin/bash

ENVIRONMENT=$1

echo "Starting deployment to environment: $ENVIRONMENT"

echo "Using API_KEY: $API_KEY"
echo "Using DB_URL: $DB_URL"

echo "Deployment to $ENVIRONMENT completed successfully"
```

### Make it executable (locally)

```bash
chmod +x scripts/deploy.sh
```

ğŸ“Œ **Important**

* Secrets will be **masked automatically** in GitHub Actions logs
* This script is intentionally simple for learning

---

## 2ï¸âƒ£ Add Secrets in GitHub (MANDATORY)

Go to:

```
Repository â†’ Settings â†’ Secrets and variables â†’ Actions â†’ New repository secret
```

Add:

| Name      | Value       |
| --------- | ----------- |
| `API_KEY` | `dummy-key` |
| `DB_URL`  | `dummy-db`  |

âœ… These secrets are **encrypted** and **masked in logs**

---

## 3ï¸âƒ£ Configure Environments (IMPORTANT STEP)

### Go to:

```
Settings â†’ Environments
```

---

### ğŸ”¹ Create Environment: `dev`

* No approval needed

---

### ğŸ”¹ Create Environment: `staging`

* No approval needed

---

### ğŸ”¹ Create Environment: `production`

* âœ… Enable **Required reviewers**
* Add **your GitHub username**

ğŸ“Œ This creates a **manual approval gate**

---

## 4ï¸âƒ£ GitHub Actions Workflow (CORE IMPLEMENTATION)

### ğŸ“„ `.github/workflows/conditional-deploy.yml`

```yaml
name: Conditional Deployment Pipeline

on:
  push:
    branches:
      - main
      - develop
  workflow_dispatch:

jobs:

  # ------------------------
  # BUILD JOB (ALWAYS RUNS)
  # ------------------------
  build:
    name: Build Application
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build step
        run: echo "Building application..."

  # ------------------------
  # DEV DEPLOY (develop)
  # ------------------------
  deploy-dev:
    name: Deploy to Dev
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/develop'
    environment: dev

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to Dev
        env:
          API_KEY: ${{ secrets.API_KEY }}
          DB_URL: ${{ secrets.DB_URL }}
        run: |
          ./scripts/deploy.sh dev

  # ------------------------
  # STAGING DEPLOY (main)
  # ------------------------
  deploy-staging:
    name: Deploy to Staging
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    environment: staging

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to Staging
        env:
          API_KEY: ${{ secrets.API_KEY }}
          DB_URL: ${{ secrets.DB_URL }}
        run: |
          ./scripts/deploy.sh staging

  # ------------------------
  # PROD DEPLOY (APPROVAL)
  # ------------------------
  deploy-prod:
    name: Deploy to Production
    needs: deploy-staging
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    environment: production

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to Production
        env:
          API_KEY: ${{ secrets.API_KEY }}
          DB_URL: ${{ secrets.DB_URL }}
        run: |
          ./scripts/deploy.sh prod
```

---

## 5ï¸âƒ£ Execution Flow (VERY IMPORTANT)

### ğŸ”¹ Push to `develop`

```
git checkout develop
git push origin develop
```

âœ” Build runs
âœ” Deploys to **dev**
âŒ staging/prod skipped

---

### ğŸ”¹ Push to `main`

```
git checkout main
git push origin main
```

âœ” Build runs
âœ” Deploys to **staging**
â¸ **Production waits for approval**

---

### ğŸ”¹ Approve Production

1. Go to **Actions**
2. Open workflow run
3. Click **Review deployments**
4. Approve â†’ Production deploy runs

---

## 6ï¸âƒ£ Verify Secret Masking ğŸ”’

Logs will show:

```
Using API_KEY: ***
Using DB_URL: ***
```

ğŸ“Œ GitHub **never prints secret values**

---

## 7ï¸âƒ£ Experiment Tasks (MANDATORY)

### ğŸ§ª Experiment 1: Wrong Condition

Change:

```yaml
if: github.ref == 'refs/heads/main'
```

to:

```yaml
if: github.ref == 'main'
```

ğŸ‘‰ Observe: Job is **skipped**

---

### ğŸ§ª Experiment 2: Remove Environment

Remove:

```yaml
environment: production
```

ğŸ‘‰ Observe:
âŒ No approval required
âš ï¸ Dangerous in real systems

---

### ğŸ§ª Experiment 3: Echo Secret Directly

```bash
echo $API_KEY
```

ğŸ‘‰ Output still masked (`***`)

---

## 8ï¸âƒ£ Exam / Interview Key Points ğŸ§ 

* Secrets are **encrypted & masked**
* `environment:` enables approval gates
* `if:` controls job execution
* `needs:` defines deployment order
* Production should **always** have manual approval
* Branch-based deployment is industry standard

---

## 9ï¸âƒ£ Common Mistakes âŒ

| Mistake                        | Result              |
| ------------------------------ | ------------------- |
| Missing `environment`          | No approval         |
| Wrong `github.ref`             | Job skipped         |
| Printing secrets               | Masked              |
| No `needs:`                    | Prod before staging |
| Using secrets in YAML directly | âŒ Security risk     |

---

## ğŸ”Ÿ Final Outcome

âœ” Secure CI/CD
âœ” Controlled deployments
âœ” Secrets protected
âœ” Manual approvals enforced
âœ” Enterprise-grade pipeline

---

## ğŸ“Œ Real-World Mapping

| GitHub Actions | Enterprise CI/CD    |
| -------------- | ------------------- |
| Environments   | Promotion stages    |
| Secrets        | Vault / AWS Secrets |
| Approval gates | Change management   |
| Branch rules   | Release strategy    |

---

If you want next:

* ğŸ”¹ Convert this to **reusable workflow**
* ğŸ”¹ Add **Slack approval notifications**
* ğŸ”¹ Compare with **Jenkins approval gates**
* ğŸ”¹ Turn this into **exam Q&A**

Just tell me ğŸ‘
