Below is a **complete, end-to-end lab guide** for **Exercise 1: Matrix Builds with Caching and Artifact Sharing**.
It is written so you can **implement it exactly**, verify results in GitHub Actions, and also use it as **exam / viva notes**.

---

# ğŸ§ª Exercise 1: Matrix Builds with Caching and Artifact Sharing (Node.js)

## ğŸ¯ Objectives

* Run tests **in parallel** across multiple Node.js versions
* **Cache dependencies** to speed up CI
* **Share artifacts** between jobs
* Understand **job dependencies (`needs`)**
* Observe behavior when cache breaks or tests fail

---

## 1ï¸âƒ£ Prerequisites

* GitHub repository
* Node.js knowledge (basic)
* GitHub Actions enabled (default)

---

## 2ï¸âƒ£ Project Structure (Create This Exactly)

```
node-matrix-demo/
â”œâ”€â”€ .github/
â”‚   â””â”€â”€ workflows/
â”‚       â””â”€â”€ matrix-ci.yml
â”œâ”€â”€ src/
â”‚   â””â”€â”€ sum.js
â”œâ”€â”€ tests/
â”‚   â””â”€â”€ sum.test.js
â”œâ”€â”€ package.json
â”œâ”€â”€ package-lock.json
```

---

## 3ï¸âƒ£ Create a Simple Node.js App

### ğŸ“„ `src/sum.js`

```js
function sum(a, b) {
  return a + b;
}

module.exports = sum;
```

---

### ğŸ“„ `tests/sum.test.js`

```js
const sum = require('../src/sum');

test('adds 1 + 2 to equal 3', () => {
  expect(sum(1, 2)).toBe(3);
});
```

---

## 4ï¸âƒ£ Create `package.json`

```json
{
  "name": "matrix-node-demo",
  "version": "1.0.0",
  "scripts": {
    "test": "jest"
  },
  "devDependencies": {
    "jest": "^29.7.0"
  }
}
```

---

### ğŸ“Œ Generate `package-lock.json`

Run locally once:

```bash
npm install
```

Commit **both** `package.json` and `package-lock.json`.

---

## 5ï¸âƒ£ GitHub Actions Workflow (MAIN PART)

### ğŸ“„ `.github/workflows/matrix-ci.yml`

```yaml
name: Matrix Node CI with Cache and Artifacts

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:

  # -----------------------------
  # SETUP JOB (INSTALL + CACHE)
  # -----------------------------
  setup:
    name: Setup Dependencies
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Archive node_modules
        uses: actions/upload-artifact@v4
        with:
          name: node-modules
          path: node_modules

  # -----------------------------
  # TEST JOB (MATRIX)
  # -----------------------------
  test:
    name: Test on Node ${{ matrix.node }}
    needs: setup
    runs-on: ubuntu-latest

    strategy:
      matrix:
        node: [16, 18, 20]

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Node.js ${{ matrix.node }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node }}

      - name: Download dependencies
        uses: actions/download-artifact@v4
        with:
          name: node-modules
          path: node_modules

      - name: Run tests
        run: npm test

      - name: Upload test report
        uses: actions/upload-artifact@v4
        with:
          name: test-results-node-${{ matrix.node }}
          path: .
          if-no-files-found: ignore

  # -----------------------------
  # ARCHIVE JOB (COLLECT RESULTS)
  # -----------------------------
  archive:
    name: Archive All Test Results
    needs: test
    runs-on: ubuntu-latest

    steps:
      - name: Download all test artifacts
        uses: actions/download-artifact@v4
        with:
          path: all-test-results

      - name: List collected artifacts
        run: ls -R all-test-results

      - name: Upload combined report
        uses: actions/upload-artifact@v4
        with:
          name: combined-test-reports
          path: all-test-results
```

---

## 6ï¸âƒ£ What Happens During Execution (Very Important)

### ğŸ”¹ Setup Job

* Runs once
* Installs dependencies
* Saves `node_modules` as artifact
* Uses npm cache

---

### ğŸ”¹ Test Job (Matrix)

* Runs **3 jobs in parallel**

  * Node 16
  * Node 18
  * Node 20
* Downloads shared dependencies
* Executes tests independently
* Uploads artifacts per Node version

---

### ğŸ”¹ Archive Job

* Runs only after **all test jobs succeed**
* Downloads **all matrix artifacts**
* Uploads a combined artifact

---

## 7ï¸âƒ£ Verify in GitHub Actions UI

âœ” Matrix shows **3 parallel jobs**
âœ” First run â†’ cache **miss**
âœ” Second run â†’ cache **hit**
âœ” Artifacts tab shows:

* `node-modules`
* `test-results-node-16`
* `test-results-node-18`
* `test-results-node-20`
* `combined-test-reports`

---

## 8ï¸âƒ£ Experiment Tasks (MANDATORY)

### ğŸ§ª Experiment 1: Break Cache

Change:

```yaml
cache: npm
```

to:

```yaml
cache: yarn
```

ğŸ‘‰ Observe cache miss / failure.

---

### ğŸ§ª Experiment 2: Introduce Test Failure

Modify test:

```js
expect(sum(1, 2)).toBe(4);
```

ğŸ‘‰ Observe:

* One matrix job fails
* `archive` job is **skipped**
* Other matrix jobs still run

---

### ğŸ§ª Experiment 3: Skip Node Version

Add condition:

```yaml
if: matrix.node != 16
```

ğŸ‘‰ Node 16 job skipped

---

## 9ï¸âƒ£ Exam / Interview Key Points ğŸ§ 

* Matrix jobs run **in parallel**
* Cache is **per runner, per key**
* Artifacts are used to share data **between jobs**
* `needs` enforces job order
* One failing matrix job does **not stop others**
* Downstream jobs skip on failure by default

---

## ğŸ”Ÿ Common Mistakes âŒ

| Mistake                        | Result          |
| ------------------------------ | --------------- |
| Missing `package-lock.json`    | Cache fails     |
| No `needs:`                    | Race conditions |
| Uploading large artifacts      | Slow pipeline   |
| Assuming node_modules persists | âŒ Wrong         |

---

## âœ… Final Outcome

âœ” Optimized CI
âœ” Faster re-runs
âœ” Parallel testing
âœ” Real-world DevOps pattern
âœ” Exam-ready understanding

---

If you want next:

* ğŸ”¹ Convert this to **GitHub Actions reusable workflow**
* ğŸ”¹ Compare with **Jenkins matrix builds**
* ğŸ”¹ Add **SonarQube / Coverage**
* ğŸ”¹ Turn this into **exam Q&A**

Just say ğŸ‘
